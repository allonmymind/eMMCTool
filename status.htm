<%+header%>
<style>
  .card {
    background: var(--cbi-section-bg, #fff);
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
    margin-bottom: 20px;
    position: relative;
  }
  .card h3 {
    margin-top: 0;
    color: var(--cbi-section-header-color, #2c3e50);
    font-weight: 600;
    font-size: 1.2em;
    border-bottom: 2px solid var(--cbi-section-header-color, #2c3e50);
    padding-bottom: 6px;
  }
  .info-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
  }
  .info-table th, .info-table td {
    text-align: left;
    padding: 6px 8px;
    vertical-align: top;
  }
  .info-table th {
    background: var(--cbi-section-bg-alt, #f9fafb);
    width: 150px;
  }
  .progress-bar {
    height: 18px;
    background: #eee;
    border-radius: 9px;
    overflow: hidden;
    margin-top: 6px;
    width: 100%;
  }
  .progress-fill {
    height: 100%;
    background: var(--cbi-button-bg, #007AFF);
    transition: width 0.5s ease;
  }
  .remark {
    font-size: x-small;
    font-style: italic;
    color: #666;
    margin-top: 2px;
    display: block;
  }
  #resultConsole {
    background: #1e1e2f;
    color: #a0a0ff;
    font-family: monospace;
    font-size: 13px;
    white-space: pre-wrap;
    max-height: 300px;
    overflow-y: auto;
    padding: 12px;
    border-radius: 6px;
    margin-top: 15px;
    display: none;
  }
  .btn-center {
    text-align: center;
    margin-bottom: 15px;
  }
  #speedResults {
    list-style:none;  
    padding-left:0;  
    font-family: monospace;  
    margin-top: 10px;
  }
  #speedResults li {
    margin-bottom: 6px;
    font-weight: 600;
    color: var(--cbi-section-header-color, #2c3e50);
  }
  /* 时间戳红色固定位置 */
  #lastCheckTime {
    position: absolute;
    right: 20px;
    bottom: 12px;
    color: red;
    font-size: 0.85em;
    font-weight: 600;
    font-family: monospace;
    user-select: none;
  }
</style>

<h2 class="cbi-section-title">eMMC 检测工具</h2>
<p>点击下方按钮运行检测，显示型号、寿命和速度信息。</p>

<div class="btn-center">
  <button class="cbi-button cbi-button-apply" onclick="runCheck()">运行检测</button>
</div>

<div id="infoCards" style="display:none; position: relative;">
  <div class="card" id="basicInfo">
    <h3>基本信息</h3>
    <table class="info-table">
      <tbody>
        <tr><th>型号</th><td id="model"></td></tr>
        <tr><th>容量</th><td id="capacity"></td></tr>
        <tr><th>生产日期</th><td id="date"></td></tr>
        <tr><th>CID</th><td id="cid"></td></tr>
        <tr><th>挂载点</th><td id="device"></td></tr>
      </tbody>
    </table>
  </div>

  <div class="card" id="healthInfo">
    <h3>寿命信息</h3>
    <table class="info-table">
      <tbody>
        <tr>
          <th>
            已使用寿命 - 擦除次数<br>
            <span class="remark">（预估，阶梯10%）</span>
          </th>
          <td>
            <span id="lifeA_val"></span>
            <div class="progress-bar"><div id="lifeA_bar" class="progress-fill"></div></div>
          </td>
        </tr>
        <tr>
          <th>
            已使用寿命 - 写入量<br>
            <span class="remark">（预估，阶梯10%）</span>
          </th>
          <td>
            <span id="lifeB_val"></span>
            <div class="progress-bar"><div id="lifeB_bar" class="progress-fill"></div></div>
          </td>
        </tr>
        <tr><th>Pre EOL 信息</th><td id="preEOL"></td></tr>
      </tbody>
    </table>
  </div>

  <div class="card" id="speedInfo" style="position: relative;">
    <h3>速度测试</h3>
    <ul id="speedResults"></ul>
    <div id="lastCheckTime" title="最后检测时间"></div>
  </div>

  <details id="resultConsole" open>
    <summary style="cursor:pointer; user-select:none;">详细检测日志 (可折叠)</summary>
    <pre id="rawOutput"></pre>
  </details>
</div>

<script type="text/javascript">
function formatDateTime(date) {
  const pad = (n) => n < 10 ? '0' + n : n;
  return date.getFullYear() + '-' + pad(date.getMonth()+1) + '-' + pad(date.getDate()) + ' ' + pad(date.getHours()) + ':' + pad(date.getMinutes()) + ':' + pad(date.getSeconds());
}

function loadFromStorage() {
  try {
    const savedData = localStorage.getItem("emmcinfo_last_result");
    const savedTime = localStorage.getItem("emmcinfo_last_time");
    if (savedData && savedTime) {
      document.getElementById("rawOutput").textContent = savedData;
      document.getElementById("infoCards").style.display = "block";

      // 显示时间戳
      document.getElementById("lastCheckTime").textContent = "检测时间: " + savedTime;

      // 解析并填充数据，复用runCheck的解析部分逻辑
      parseAndFill(savedData);
    }
  } catch(e) {
    console.warn("加载本地缓存失败", e);
  }
}

function parseAndFill(txt) {
  try {
    // [修正] 修正了正则表达式，以统一处理标签和冒号之间的可选空格，增强代码的健壮性。
    const devMatch = txt.match(/Device\s*:\s*(.*)/);
    const modelMatch = txt.match(/Model\s*:\s*(.*)/);
    const cidMatch = txt.match(/CID\s*:\s*(.*)/);
    const dateMatch = txt.match(/Date\s*:\s*(.*)/);
    const capacityMatch = txt.match(/Capacity\s*:\s*(.*)/);

    if (devMatch) document.getElementById("device").textContent = devMatch[1].trim();
    if (modelMatch) document.getElementById("model").textContent = modelMatch[1].trim();
    if (cidMatch) document.getElementById("cid").textContent = cidMatch[1].trim();
    if (dateMatch) document.getElementById("date").textContent = dateMatch[1].trim();
    if (capacityMatch) document.getElementById("capacity").textContent = capacityMatch[1].trim();

    // 寿命信息
    const lifeAMatch = txt.match(/Life Time Estimation A\s*:\s*0x([0-9a-fA-F]+) \(~(\d+)% used\)/);
    const lifeBMatch = txt.match(/Life Time Estimation B\s*:\s*0x([0-9a-fA-F]+) \(~(\d+)% used\)/);
    const preEOLMatch = txt.match(/Pre EOL info\s*:\s*(0x[0-9a-fA-F]+) \((.*)\)/);

    if (lifeAMatch) {
      const percentA = parseInt(lifeAMatch[2]);
      document.getElementById("lifeA_val").textContent = `${percentA}%`;
      document.getElementById("lifeA_bar").style.width = percentA + "%";
    }
    if (lifeBMatch) {
      const percentB = parseInt(lifeBMatch[2]);
      document.getElementById("lifeB_val").textContent = `${percentB}%`;
      document.getElementById("lifeB_bar").style.width = percentB + "%";
    }
    if (preEOLMatch) {
      document.getElementById("preEOL").textContent = preEOLMatch[2];
    }

    // 速度测试简洁展示
    const speedSection = txt.split("==== eMMC Speed Test ====")[1];
    if (speedSection) {
      const lines = speedSection.split("\n").map(l => l.trim()).filter(l => l.length > 0);

      // 解析写入速度
      let writeSpeed = null;
      for(let line of lines) {
        let m = line.match(/([\d\.]+)\s*(MB|GB)\/s/);
        if (m && line.toLowerCase().includes("copied")) {
          writeSpeed = m[1] + " " + m[2] + "/s";
          break;
        }
      }

      // 解析读取速度
      let readSpeed = null;
      for(let line of lines) {
        let m = line.match(/([\d\.]+)\s*(MB|GB)\/s/);
        if (m && line.toLowerCase().includes("reading")) {
          readSpeed = m[1] + " " + m[2] + "/s";
          break;
        }
      }
      if (!readSpeed) {
        for(let line of lines) {
          if(line.toLowerCase().includes("bytes") && line.toLowerCase().includes("copied") && !line.toLowerCase().includes("write")) {
            let m = line.match(/([\d\.]+)\s*(MB|GB)\/s/);
            if(m) { readSpeed = m[1] + " " + m[2] + "/s"; break;}
          }
        }
      }

      // 解析 hdparm 测速
      let hdparmCached = null;
      let hdparmBuffered = null;
      for(let line of lines) {
        let cachedM = line.match(/Timing cached reads:\s+([\d\.]+) MB in\s+[\d\.]+ seconds = ([\d\.]+) MB\/sec/);
        let bufferedM = line.match(/Timing buffered disk reads:\s+([\d\.]+) MB in\s+[\d\.]+ seconds = ([\d\.]+) MB\/sec/);
        if(cachedM) hdparmCached = cachedM[2] + " MB/s";
        if(bufferedM) hdparmBuffered = bufferedM[2] + " MB/s";
      }

      const ul = document.getElementById("speedResults");
      ul.innerHTML = "";
      if(writeSpeed)
        ul.insertAdjacentHTML("beforeend", `<li>写入速度: ${writeSpeed}</li>`);
      if(readSpeed)
        ul.insertAdjacentHTML("beforeend", `<li>读取速度: ${readSpeed}</li>`);
      if(hdparmCached)
        ul.insertAdjacentHTML("beforeend", `<li>缓存读取速度 (hdparm): ${hdparmCached}</li>`);
      if(hdparmBuffered)
        ul.insertAdjacentHTML("beforeend", `<li>缓冲读取速度 (hdparm): ${hdparmBuffered}</li>`);

      if(!writeSpeed && !readSpeed && !hdparmCached && !hdparmBuffered) {
        ul.insertAdjacentHTML("beforeend", `<li>速度测试结果无法解析</li>`);
      }
    }
  } catch(e) {
    console.warn("解析异常", e);
  }
}

function runCheck() {
  const btn = document.querySelector("button.cbi-button-apply");
  btn.disabled = true;
  btn.textContent = "检测中，请稍候...";

  // 清理旧内容
  document.getElementById("infoCards").style.display = "none";
  document.getElementById("rawOutput").textContent = "";
  document.getElementById("speedResults").innerHTML = "";
  document.getElementById("device").textContent = "";
  document.getElementById("model").textContent = "";
  document.getElementById("cid").textContent = "";
  document.getElementById("date").textContent = "";
  document.getElementById("capacity").textContent = "";
  document.getElementById("lifeA_val").textContent = "";
  document.getElementById("lifeB_val").textContent = "";
  document.getElementById("lifeA_bar").style.width = "0%";
  document.getElementById("lifeB_bar").style.width = "0%";
  document.getElementById("preEOL").textContent = "";
  document.getElementById("lastCheckTime").textContent = "";

  fetch('<%=url([[admin]], [[system]], [[emmcinfo_run]])%>')
    .then(res => res.text())
    .then(txt => {
      document.getElementById("rawOutput").textContent = txt;
      btn.disabled = false;
      btn.textContent = "运行检测";
      document.getElementById("infoCards").style.display = "block";

      // 显示当前检测时间戳
      const nowStr = formatDateTime(new Date());
      document.getElementById("lastCheckTime").textContent = "检测时间: " + nowStr;

      // 保存结果和时间到localStorage
      try {
        localStorage.setItem("emmcinfo_last_result", txt);
        localStorage.setItem("emmcinfo_last_time", nowStr);
      } catch(e) {
        console.warn("保存检测结果失败", e);
      }

      // 解析并填充数据
      parseAndFill(txt);
    })
    .catch(err => {
      alert("检测出错: " + err);
      btn.disabled = false;
      btn.textContent = "运行检测";
    });
}

// 页面加载时自动尝试加载上次结果
window.onload = function() {
  loadFromStorage();
};
</script>
<%+footer%>
